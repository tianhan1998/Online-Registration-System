<!DOCTYPE html>
<html language="zh">

<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>INSPINIA | Register</title>

	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="font-awesome/css/font-awesome.css" rel="stylesheet">
	<link href="css/plugins/iCheck/custom.css" rel="stylesheet">
	<link href="css/animate.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	<link rel="shortcut icon" href="#" />

</head>

<body class="gray-bg">

<div class="middle-box text-center loginscreen   animated fadeInDown">

	<div>
		<div>
<!--			<h1 class="logo-name">IN+</h1>-->
		</div>
		<h3>注册</h3>
		<p>创建属于您的账号</p>
		<div class="tabbable" id="tabs-215554">
			<ul class="nav nav-tabs">
				<li class="active">
					<a href="#panel-967992" data-toggle="tab">个人账号</a>
				</li>
				<li>
					<a href="#panel-884429" data-toggle="tab">团队账户</a>
				</li>
			</ul>
			<div class="tab-content">
				<div class="tab-pane active" id="panel-967992">
					<p>
						<form id="memForm" class="m-t" role="form">
							<input type="hidden" name="type" value="0">
							<div class="form-group">
								<input id="mem-id" name="memId" type="text"  class="form-control" placeholder="学号" required="">
								<div id="mem-id-log" class="badge badge-primary" style="display: none">该学号已被注册</div>
							</div>
							<div class="form-group">
								<input id="mem-name" name="memName" type="text" class="form-control" placeholder="姓名" required="">
								<div id="mem-name-log" class="badge badge-primary" style="display: none">该学号已被注册</div>
							</div>
							<div class="form-group">
								<select id="mem-sex" name="memSex" class="form-control">
									<option value="M">男</option>
									<option value="F">女</option>
								</select>
							</div>
							<div class="form-group">
								<input id="mem-email" name="memEmail" type="email" class="form-control" placeholder="电子邮箱" required="">
								<div id="mem-email-log" class="badge badge-primary" style="display: none">该学号已被注册</div>
							</div>
							<div class="form-group">
								<input id="pwd1" name="memPassword" type="password" class="form-control" placeholder="密码" required="">
							</div>
							<div class="form-group">
								<input id="pwd2" type="password" class="form-control" placeholder="二次密码" required="">
								<div id="pwd-log" class="badge label label-danger" style="display: none">两次密码不一致</div>
							</div>
							<div class="form-group">
								<input id="code" name="code" type="text" class="form-control" placeholder="验证码" required="">
								<img src="./api/getVeifyCode" onclick="yzm(this)">
							</div>
							<button id="memSubmit" type="button" class="btn btn-primary block full-width m-b">注册</button>
					<p class="text-muted text-center"><small>已经有账号了吗?</small></p>
					<a class="btn btn-sm btn-white btn-block" href="login">登陆</a>
					</form>
					</p>
				</div>
				<div class="tab-pane" id="panel-884429">
					<p>
						<form id="teamForm" class="teamForm" role="form">
							<input type="hidden" name="type" value="1">
							<div class="form-group">
								<input id="team-accound" type="text" name="teamAccount" class="form-control" placeholder="账号" required="">
								<div id="team-accound-log" class="badge badge-primary" style="display: none">该账户已被注册</div>
							</div>
							<div class="form-group">
								<input id="team_name" type="text" name="teamName" class="form-control" placeholder="团队名称" required="">
								<div id="team_name-log" class="badge badge-primary" style="display: none">该账户已被注册</div>
							</div>
							<div class="form-group">
								<input id="team_email" type="email" name="teamEmail" class="form-control" placeholder="邮箱" required="">
								<div id="team_email-log" class="badge badge-primary" style="display: none">该账户已被注册</div>
							</div>
							<div class="form-group">
								<input id="team_pwd" type="password" name="teamPassword" class="form-control" placeholder="密码" required="">
							</div>
							<div class="form-group">
								<input id="team-pwd2" type="password" class="form-control" placeholder="二次密码" required="">
								<div id="team-pwd-log" class="label label-danger" style="display: none">两次密码不一致</div>
							</div>
							<div class="form-group">
								<input id="code1" name="code" type="text" class="form-control" placeholder="验证码" required="">
								<img src="./api/getVeifyCode" onclick="yzm(this)">
							</div>
							<button id="team-submit" type="button" class="btn btn-primary block full-width m-b">注册</button>

					<p class="text-muted text-center"><small>已经有账号了吗?</small></p>
					<a class="btn btn-sm btn-white btn-block" href="login">登陆</a>
					</form>
					</p>
				</div>
			</div>
		</div>
		<p class="m-t"> <small>©2019 安阳师范学院软件学院算法艺术社 版权所有</small> </p>
		<p class="m-t"> <small>©2019 SCHOOL OF SOFTWARE ENGINEERING AYNU Algorithm art club All Rights Reserved</small> </p>
	</div>
</div>

<!-- Mainly scripts -->
<script src="js/jquery-2.1.1.js"></script>
<script src="js/bootstrap.min.js"></script>
<!-- iCheck -->
<script src="js/plugins/iCheck/icheck.min.js"></script>
<!--		引入加密-->
<script src="https://cdn.bootcss.com/jsencrypt/3.0.0-beta.1/jsencrypt.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script>
	var publicKey;
	var encrypt = new JSEncrypt();//RSA加密对象

	function yzm(img){
		img.src="./api/getVeifyCode?id="+ new Date().getTime();
	}


	$(function () {
		//获取RSA公钥
		$.ajax({
			url:"./api/getPublicKey",
			dataType:"json",
			type:"get",
			success:function (result) {
				console.log("公钥为"+result.data);//获取公钥
				publicKey=result.data;
				encrypt.setPublicKey(publicKey)//设置公钥
			}
		});
	});


	$(document).ready(function() {

		//学号是否通过验证
		var flagMemId=0;
		var flagMedPwd=0;
		var flagMemName=0;
		var falgMemEmail=0;
		var flagyzm=0;
		
		//个人验证码校验
		$("#code").blur(function () {
			var reg=/^\d{4}$/;

			var code=$("#code").val();

			if(reg.test(code)){
				flagyzm=1;
			}else{
				swal("验证码不合法");
				flagyzm=0;
			}
		});
		
		//个人注册邮箱验证
		$("#mem-email").blur(function () {
			var email=$("#mem-email").val();
			var reg = /^([a-zA-Z]|[0-9])(\w|\-)+@[a-zA-Z0-9]+\.([a-zA-Z]{2,4})$/;
			if(reg.test(email)){//邮箱合法性校验
				$.ajax({
					type:"get",
					url:"./checkMemEmail",
					dataType:"json",
					data:{"email":email},
					success:function (result) {
						console.log(result);
						if(result.code=="200"){//可以注册
							falgMemEmail=1;
							var log=$("#mem-email-log").show().removeClass().addClass("badge badge-primary");
							log.empty().append(result.msg);
						}else{//不能注册
							falgMemEmail=0;
							var log=$("#mem-email-log").show().removeClass().addClass("badge label-danger");
							log.empty().append(result.msg);
						}
					},
					error:function (result) {
						falgMemEmail=0;
						var log=$("#mem-email-log").show().removeClass().addClass("badge label-danger");
						log.empty().append(result.msg);
					}
				});

			}else{
				var log=$("#mem-email-log").show().removeClass().addClass("badge label-danger");
				log.empty().append("邮箱格式有误");
				falgMemEmail=0;
			}
		});

		//个人注册姓名验证
		$("#mem-name").blur(function () {
			var name=$("#mem-name").val();
			if(name.length>0&&name.length<10){
				flagMemName=1;
				var log=$("#mem-name-log").show().removeClass().addClass("badge badge-primary");
				log.empty().append("通过验证");
			}else{
				var log=$("#mem-name-log").show().removeClass().addClass("badge label-danger");
				log.empty().append("姓名长度要合法");
				flagMemName=0;
			}
		});

		// var flagMemId=0;
		// var flagMedPwd=0;
		// var flagMemName=0;
		// var falgMemEmail=0;
		// var flagyzm=0;

		//个人注册
		$("#memSubmit").click(function () {
			if(flagMemId==1&&flagMedPwd==1&&flagMemName==1&&falgMemEmail==1&&flagyzm==1){

				var password=$('#pwd1').val();
				var item=password;

				console.log("加密前"+password);
				password=encrypt.encrypt(password);
				$('#pwd1').val(password);
				console.log("加密后"+password);

				$.ajax({
					type:"post",
					url:"./signUpMem",
					dataType:"json",
					data:$("#memForm").serialize(),
					success:function (result) {
						console.log(result);
						if(result.code=="200"){//注册成功需要重新登录
							swal("注册成功").then(function () {
								window.location.href="login";
							});
						}else {//登陆失败
							console.log(result.msg);
							$('#pwd1').val(item);//失败密码替换掉
							swal(result.msg).then(function () {
								window.location.reload();
							});
						}
					},
					error:function (result) {
						console.log(result.msg);
					}
				})
			}else{
				swal("请完善您的信息");
				console.log(flagMemId+" "+flagMedPwd+" "+flagMemName+" "+falgMemEmail+" "+flagyzm);
			}
		});

		$("#mem-id").blur(function () {//验证该账户是否被注册
			var memId=$("#mem-id").val();
			var reg=/^\d{9}$/;

			if(reg.test(memId)){
				$.ajax({
					type:"get",
					url:"./signUp",
					dataType:"json",
					data:{"memId":memId},
					success:function (result) {
						console.log(result);

						if(result.code=="200"){//可以注册
							var log=$("#mem-id-log").show().removeClass().addClass("badge badge-primary");
							log.empty().append("可以使用");
							//label label-danger 失败
							//badge badge-primary 成功
							flagMemId=1;
						}else{//不能注册
							var log=$("#mem-id-log").show().removeClass().addClass("badge label-danger");
							log.empty().append("该学号已经被注册不能使用");
							flagMemId=0;
						}
					},
					error:function (result) {
						var log=$("#mem-id-log").show().removeClass().addClass("badge label-danger");
						log.empty().append("学号位数过长");
						flagMemId=0;
					}
				});
			}else{
				var log=$("#mem-id-log").show().removeClass().addClass("badge label-danger");
				log.empty().append("学号长度不合法,且学号必须是纯数字");
				flagMemId=0;
			}
		});

		//校验两次密码要一样
		$("#pwd2").blur(function () {
			var pwd1=$("#pwd1").val();
			var pwd2=$("#pwd2").val();
			if(pwd1.length>3){
				if(pwd1!=pwd2) {
					$("#pwd-log").show().empty().append("两次密码不一致");
					flagMedPwd=0;
				}else{
					$("#pwd-log").hide();
					flagMedPwd=1;
				}
			}else{
				swal("密码位数最小需要3位");
				flagMedPwd=0;
			}
		});


		var falgTeamAccound=0;
		var falgTeamPwd=0;
		var flagTeamName=0;
		var flagTeamEmail=0;
		var flagTeamCode=0;
		// * @param memEmail 安全邮箱
		// * @param team_account 队伍账号
		// * @param team_name 队伍名称
		// * @param team_password 队伍密码
		// * @param type 类型，0是个人，1是团队
		//label label-danger 失败
		//badge badge-primary 成功

		//团队验证码
		//个人验证码校验
		$("#code1").blur(function () {
			var reg=/^\d{4}$/;

			var code=$("#code1").val();

			if(reg.test(code)){
				flagyzm=1;
			}else{
				swal("验证码不合法");
				flagyzm=0;
			}
		});

		//验证团队团队邮箱
		$("#team_email").blur(function () {
			var name=$("#team_email").val();
			var reg = /^([a-zA-Z]|[0-9])(\w|\-)+@[a-zA-Z0-9]+\.([a-zA-Z]{2,4})$/;

			if(reg.test(name)){//邮箱合法性校验{
				$.ajax({
					type:"get",
					url:"./checkTeamEmail",
					dataType:"json",
					data:{"email":name},
					success:function (result) {
						console.log(result);
						if(result.code=="200"){//可以注册
							var log=$("#team_email-log").show().removeClass().addClass("badge badge-primary");
							log.empty().append(result.msg);
							flagTeamEmail=1;
						}else{//不能注册
							var log=$("#team_email-log").show().removeClass().addClass("badge label-danger");
							log.empty().append(result.msg);
							flagTeamEmail=0;
						}
					},
					error:function (result) {
						var log=$("#team_email-log").show().removeClass().addClass("badge label-danger");
						log.empty().append(result.msg);
						flagTeamEmail=0;
					}
				});
			}else{
				var log=$("#team_email-log").show().removeClass().addClass("badge label-danger");
				log.empty().append("邮箱格式不合法");
				flagTeamEmail=0;
			}
		});

		//验证团队名称
		$("#team_name").blur(function () {
			var name=$("#team_name").val();
			if(name.length>0){
				var log=$("#team_name-log").show().removeClass().addClass("badge badge-primary");
				log.empty().append("该队名可以使用");
				flagTeamName=1;
			}else{
				var log=$("#team_name-log").show().removeClass().addClass("badge label-danger");
				log.empty().append("队名不能为空");
				flagTeamName=0;
			}
		});


		//提交团队注册
		$("#team-submit").click(function () {
			if(falgTeamAccound==1&&falgTeamPwd==1){
				var password=$('#team_pwd').val();
				var item=password;

				console.log("加密前"+password);
				password=encrypt.encrypt(password);
				$('#team_pwd').val(password);
				console.log("加密后"+password);

				$.ajax({
					type:"post",
					dataType:"json",
					data:$("#teamForm").serialize(),
					url:"./signUpTeam",
					success:function (result) {
						if(result.code=="200"){
							console.log(result.msg);
							swal("注册成功").then(function () {
								window.location.href="login";
							});
						}else{
							$('#team_pwd').val(item);//失败密码还回去
							swal(result.msg).then(function () {
								window.location.reload();
							});
						}
					},
					error:function (result) {
						console.log(result.msg);
						$('#team_pwd').val(item);//失败密码还回去
						swal(result.msg);
					}
				});
			}else{
				swal("请填写所有的信息");
			}
		});

		//校验团队注册密码两次是否一致
		$("#team-pwd2").blur(function () {
			var pwd1=$("input[name='teamPassword']").val();
			var pwd2=$("#team-pwd2").val();

			var pwdLog=$("#team-pwd-log");
			if(pwd1.length>3){

				if(pwd1!=pwd2){
					pwdLog.show();
					falgTeamPwd=0;
				}else{
					pwdLog.hide();
					falgTeamPwd=1;
				}
			}else{
				swal("密码长度应该大于3位");
				falgTeamPwd=0;
			}
		});

		//校验团队账号是否存在
		$("input[name='teamAccount']").blur(function () {
			var teamAccount=$("input[name='teamAccount']").val();

			if(teamAccount.length!=0){
				$.ajax({
					type:"get",
					dataType:"json",
					url:"./signUpTeam",
					data:{"team_account":teamAccount},
					success:function (result) {
						if(result.code=="200"){//可以注册
							falgTeamAccound=1;
							$("#team-accound-log").show().empty().append(result.msg).removeClass().addClass("badge badge-primary");
						}else{
							console.log(result.msg);
							$("#team-accound-log").show().empty().append(result.msg).removeClass().addClass("label label-danger");
							falgTeamAccound=0;
						}
					},
					error:function (result) {
						falgTeamAccound=0;
						$("#team-accound-log").show().empty().append("未知错误").removeClass().addClass("label label-danger");
					}
				});
			}else{
				$("#team-accound-log").show().empty().append("账号不能为空").removeClass().addClass("label label-danger");
			}
		});
	});
</script>
</body>

</html>
